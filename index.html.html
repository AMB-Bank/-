<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SmartDiary 2.0 ‚Äî –£–º–Ω—ã–π –®–∫–æ–ª—å–Ω—ã–π –î–Ω–µ–≤–Ω–∏–∫</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Geologica:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #0D1117;
  --ink2: #2D3142;
  --muted: #7C8099;
  --bg: #F5F7FF;
  --card: #FFFFFF;
  --blue: #3D6FFF;
  --blue-l: #6B90FF;
  --blue-d: #2A52CC;
  --teal: #00C9A7;
  --rose: #FF4D6D;
  --amber: #FFB930;
  --border: #E8EBFF;
  --shadow-sm: 0 2px 12px rgba(61,111,255,.08);
  --shadow: 0 6px 30px rgba(61,111,255,.12);
  --shadow-lg: 0 16px 50px rgba(61,111,255,.18);
  --r: 20px;
  --r-sm: 12px;
  --nav-h: 72px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{scroll-behavior:smooth}
body{font-family:'Geologica',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;overflow-x:hidden}

/* ‚îÄ‚îÄ SPLASH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#splash{position:fixed;inset:0;background:var(--ink);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .6s ease}
#splash.out{opacity:0;pointer-events:none}
.sp-logo{font-family:'Nunito',sans-serif;font-size:3rem;font-weight:900;color:#fff;letter-spacing:-2px;position:relative}
.sp-logo span{color:var(--blue)}
.sp-tagline{color:rgba(255,255,255,.45);font-size:.9rem;font-weight:300;margin-top:8px;letter-spacing:.5px}
.sp-dots{display:flex;gap:8px;margin-top:48px}
.sp-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.2);animation:dotPulse 1.4s infinite}
.sp-dot:nth-child(2){animation-delay:.2s}
.sp-dot:nth-child(3){animation-delay:.4s}
@keyframes dotPulse{0%,80%,100%{opacity:.2}40%{opacity:1}}
.sp-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(61,111,255,.07) 1px,transparent 1px),linear-gradient(90deg,rgba(61,111,255,.07) 1px,transparent 1px);background-size:40px 40px;pointer-events:none}

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#auth{position:fixed;inset:0;background:var(--bg);display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px;z-index:990}
#auth.on{display:flex}
.auth-wrap{width:100%;max-width:440px}
.auth-brand{font-family:'Nunito',sans-serif;font-weight:900;font-size:2rem;color:var(--blue);letter-spacing:-1px;margin-bottom:4px;text-align:center}
.auth-brand span{color:var(--ink)}
.auth-tagline{text-align:center;font-size:.85rem;color:var(--muted);margin-bottom:32px;font-weight:300}
.auth-card{background:var(--card);border-radius:24px;padding:32px 28px;box-shadow:var(--shadow-lg);border:1px solid var(--border)}
.step-bar{display:flex;gap:6px;margin-bottom:28px}
.step-seg{flex:1;height:3px;border-radius:3px;background:var(--border);transition:.4s}
.step-seg.done{background:var(--teal)}
.step-seg.active{background:var(--blue)}
.step-title{font-family:'Nunito',sans-serif;font-size:1.3rem;font-weight:800;margin-bottom:6px;color:var(--ink)}
.step-sub{font-size:.82rem;color:var(--muted);margin-bottom:24px;line-height:1.5}
.field{margin-bottom:16px}
.field label{display:block;font-size:.78rem;font-weight:600;color:var(--muted);margin-bottom:6px;letter-spacing:.3px;text-transform:uppercase}
.field input,.field select{width:100%;padding:13px 16px;border:1.5px solid var(--border);border-radius:var(--r-sm);font-family:'Geologica',sans-serif;font-size:.95rem;color:var(--ink);background:#fff;outline:none;transition:.2s}
.field input:focus,.field select:focus{border-color:var(--blue);box-shadow:0 0 0 4px rgba(61,111,255,.1)}
.field input::placeholder{color:var(--muted)}
.phone-row{display:flex;align-items:center;gap:10px}
.phone-flag{font-size:1.1rem;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:11px 13px;white-space:nowrap;font-size:.88rem;font-weight:600;color:var(--ink2)}
.ac-wrap{position:relative}
.ac-drop{position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border:1.5px solid var(--blue);border-radius:12px;max-height:220px;overflow-y:auto;z-index:200;box-shadow:var(--shadow);display:none}
.ac-drop.open{display:block}
.ac-item{padding:11px 16px;cursor:pointer;font-size:.88rem;transition:.15s;border-bottom:1px solid var(--border)}
.ac-item:last-child{border-bottom:none}
.ac-item:hover{background:var(--bg);color:var(--blue);font-weight:600}
.ac-item mark{background:none;color:var(--blue);font-weight:700}
.btn-prim{width:100%;padding:14px;background:var(--blue);color:#fff;border:none;border-radius:var(--r-sm);font-family:'Geologica',sans-serif;font-size:1rem;font-weight:600;cursor:pointer;transition:.2s;letter-spacing:.2px;position:relative;overflow:hidden}
.btn-prim:hover{background:var(--blue-l);transform:translateY(-1px);box-shadow:0 8px 24px rgba(61,111,255,.3)}
.btn-prim:active{transform:translateY(0)}
.btn-prim.loading::after{content:'';position:absolute;inset:0;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center}
.btn-sec{width:100%;padding:12px;background:transparent;color:var(--muted);border:1.5px solid var(--border);border-radius:var(--r-sm);font-family:'Geologica',sans-serif;font-size:.9rem;font-weight:500;cursor:pointer;transition:.2s;margin-top:10px}
.btn-sec:hover{border-color:var(--blue);color:var(--blue)}
.class-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:20px}
.cls-btn{padding:10px 4px;border:1.5px solid var(--border);border-radius:10px;background:#fff;cursor:pointer;font-family:'Geologica',sans-serif;font-size:.82rem;font-weight:600;color:var(--muted);transition:.2s;text-align:center}
.cls-btn:hover{border-color:var(--blue);color:var(--blue)}
.cls-btn.sel{background:var(--blue);color:#fff;border-color:var(--blue)}
.err{color:var(--rose);font-size:.8rem;margin-top:8px;min-height:16px;font-weight:500}
.code-inputs{display:flex;gap:10px;justify-content:center;margin-bottom:8px}
.code-digit{width:54px;height:62px;border:1.5px solid var(--border);border-radius:12px;text-align:center;font-size:1.6rem;font-weight:700;font-family:'Nunito',sans-serif;color:var(--blue);outline:none;transition:.2s}
.code-digit:focus{border-color:var(--blue);box-shadow:0 0 0 4px rgba(61,111,255,.1)}

/* ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#app{display:none;flex-direction:column;min-height:100vh}
#app.on{display:flex}

/* Header */
.hdr{background:var(--card);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;border-bottom:1px solid var(--border);box-shadow:var(--shadow-sm)}
.hdr-left{display:flex;align-items:center;gap:12px}
.hdr-logo{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.25rem;color:var(--blue);letter-spacing:-0.5px}
.hdr-class{font-size:.72rem;font-weight:600;background:rgba(61,111,255,.1);color:var(--blue);padding:3px 8px;border-radius:20px}
.hdr-right{display:flex;align-items:center;gap:10px}
.hdr-xp{font-size:.75rem;font-weight:600;color:var(--muted);text-align:right}
.ava{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--teal));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:.95rem;font-family:'Nunito',sans-serif;cursor:pointer;flex-shrink:0}

/* Content */
.content{flex:1;padding:20px 16px calc(var(--nav-h) + 24px);max-width:600px;width:100%;margin:0 auto}

/* Bottom nav */
.nav{position:fixed;bottom:0;left:0;right:0;height:var(--nav-h);background:var(--card);border-top:1px solid var(--border);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom);box-shadow:0 -4px 20px rgba(61,111,255,.06)}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;color:var(--muted);transition:.2s;border:none;background:none;font-family:'Geologica',sans-serif;padding:0 4px}
.nav-btn.on{color:var(--blue)}
.nav-btn .ni{font-size:1.3rem;transition:.2s}
.nav-btn.on .ni{transform:scale(1.15)}
.nav-btn .nl{font-size:.6rem;font-weight:600;letter-spacing:.3px}
.nav-pip{width:4px;height:4px;border-radius:50%;background:var(--blue);margin-top:1px;opacity:0;transition:.2s}
.nav-btn.on .nav-pip{opacity:1}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.screen{display:none;animation:slideIn .25s cubic-bezier(.25,.46,.45,.94)}
.screen.on{display:block}
@keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ COMPONENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.ttl{font-family:'Nunito',sans-serif;font-size:1.5rem;font-weight:900;color:var(--ink);margin-bottom:4px;letter-spacing:-.5px}
.ttl-sub{font-size:.82rem;color:var(--muted);margin-bottom:20px}

/* Card */
.card{background:var(--card);border-radius:var(--r);padding:16px;margin-bottom:12px;box-shadow:var(--shadow-sm);border:1px solid var(--border)}

/* Welcome banner */
.welcome-banner{background:linear-gradient(135deg,var(--blue-d) 0%,var(--blue) 50%,var(--blue-l) 100%);border-radius:var(--r);padding:22px 20px;margin-bottom:20px;color:#fff;position:relative;overflow:hidden}
.welcome-banner::before{content:'';position:absolute;right:-30px;top:-30px;width:160px;height:160px;border-radius:50%;background:rgba(255,255,255,.06)}
.welcome-banner::after{content:'';position:absolute;right:40px;bottom:-50px;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,.04)}
.wb-name{font-family:'Nunito',sans-serif;font-size:1.4rem;font-weight:900;margin-bottom:3px}
.wb-info{font-size:.82rem;opacity:.75;font-weight:300}
.wb-xp{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.15);padding:6px 12px;border-radius:20px;font-size:.8rem;font-weight:600;margin-top:12px}

/* Quick actions */
.qa-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
.qa{background:var(--card);border-radius:16px;padding:18px 14px;cursor:pointer;border:1.5px solid var(--border);transition:.2s;position:relative;overflow:hidden}
.qa:hover{border-color:var(--blue);transform:translateY(-2px);box-shadow:var(--shadow)}
.qa-ico{font-size:1.8rem;margin-bottom:8px}
.qa-lbl{font-size:.82rem;font-weight:600;color:var(--ink2)}
.qa-hint{font-size:.7rem;color:var(--muted);margin-top:2px}

/* Schedule */
.day-scroll{display:flex;gap:8px;overflow-x:auto;padding-bottom:6px;margin-bottom:16px;scrollbar-width:none}
.day-scroll::-webkit-scrollbar{display:none}
.day-chip{padding:9px 18px;border-radius:30px;border:1.5px solid var(--border);font-size:.82rem;font-weight:600;cursor:pointer;white-space:nowrap;transition:.2s;color:var(--muted);background:var(--card)}
.day-chip.on{background:var(--blue);color:#fff;border-color:var(--blue);box-shadow:0 4px 14px rgba(61,111,255,.3)}
.lesson-row{background:var(--card);border-radius:14px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;gap:12px;border:1px solid var(--border);transition:.2s}
.lesson-row:hover{border-color:var(--blue-l);box-shadow:var(--shadow-sm)}
.ln{width:30px;height:30px;border-radius:8px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.82rem;color:var(--muted);flex-shrink:0;font-family:'Nunito',sans-serif}
.li{flex:1;min-width:0}
.li-name{font-weight:600;font-size:.92rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.li-teacher{font-size:.74rem;color:var(--muted);margin-top:2px}
.li-hw{font-size:.72rem;background:#FFF2F5;color:var(--rose);padding:2px 8px;border-radius:6px;font-weight:600;display:inline-block;margin-top:4px}
.lr{font-size:.78rem;color:var(--blue);font-weight:700;background:rgba(61,111,255,.08);padding:4px 10px;border-radius:8px;white-space:nowrap;flex-shrink:0}
.empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-ico{font-size:3rem;margin-bottom:12px}
.empty-txt{font-size:.9rem}

/* Homework */
.hw-card{background:var(--card);border-radius:var(--r);padding:18px;margin-bottom:12px;border:1px solid var(--border);transition:.2s}
.hw-card.done-card{opacity:.5}
.hw-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px}
.hw-subj{font-weight:700;font-size:.95rem;display:flex;align-items:center;gap:7px}
.diff-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.de{background:var(--teal)}.dn{background:var(--amber)}.dh{background:var(--rose)}
.hw-date{font-size:.75rem;color:var(--muted)}
.hw-body{font-size:.87rem;color:var(--ink2);line-height:1.55;margin-bottom:14px}
.hw-acts{display:flex;gap:8px}
.hw-act{flex:1;padding:9px 6px;border:1.5px solid var(--border);border-radius:10px;font-family:'Geologica',sans-serif;font-size:.76rem;font-weight:600;cursor:pointer;transition:.2s;color:var(--muted);text-align:center;background:#fff}
.hw-act:hover{border-color:var(--blue);color:var(--blue)}
.hw-act.act-done{background:var(--teal);color:#fff;border-color:var(--teal)}

/* Stats */
.stat-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.stat-cell{background:var(--card);border-radius:var(--r);padding:18px 14px;border:1px solid var(--border);text-align:center}
.stat-val{font-family:'Nunito',sans-serif;font-size:2.2rem;font-weight:900;color:var(--blue);line-height:1}
.stat-lbl{font-size:.74rem;color:var(--muted);font-weight:500;margin-top:4px}
.xp-block{background:var(--card);border-radius:var(--r);padding:18px;margin-bottom:16px;border:1px solid var(--border)}
.xp-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.xp-ttl{font-weight:700;font-size:.9rem}
.xp-lvl{font-size:.8rem;color:var(--blue);font-weight:600;background:rgba(61,111,255,.1);padding:3px 10px;border-radius:20px}
.xp-bar-bg{background:var(--bg);border-radius:10px;height:10px;overflow:hidden}
.xp-bar-fill{height:100%;border-radius:10px;background:linear-gradient(90deg,var(--blue),var(--teal));transition:.6s cubic-bezier(.25,.46,.45,.94)}
.xp-nums{display:flex;justify-content:space-between;font-size:.72rem;color:var(--muted);margin-top:6px}
.lb-block{background:var(--card);border-radius:var(--r);padding:16px;border:1px solid var(--border);margin-bottom:12px}
.lb-ttl{font-family:'Nunito',sans-serif;font-weight:800;font-size:1rem;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.lb-row{display:flex;align-items:center;gap:11px;padding:10px 0;border-bottom:1px solid var(--border)}
.lb-row:last-child{border:none}
.lb-row.me{background:linear-gradient(90deg,rgba(61,111,255,.06),transparent);border-radius:10px;padding:10px 8px;margin:0 -8px}
.lb-rank{width:26px;text-align:center;font-weight:800;font-size:.9rem;color:var(--muted);font-family:'Nunito',sans-serif}
.lb-ava{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--teal));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:.88rem;flex-shrink:0}
.lb-info{flex:1;min-width:0}
.lb-name{font-weight:600;font-size:.88rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lb-cls{font-size:.72rem;color:var(--muted)}
.lb-xp{font-weight:700;color:var(--blue);font-size:.88rem;white-space:nowrap}

/* AI Chat */
.chat-box{background:var(--card);border-radius:var(--r);border:1px solid var(--border);display:flex;flex-direction:column;height:420px;margin-bottom:12px;overflow:hidden}
.chat-msgs{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth}
.msg{max-width:82%;padding:11px 14px;border-radius:16px;font-size:.88rem;line-height:1.55;word-break:break-word}
.msg.bot{background:var(--bg);color:var(--ink);align-self:flex-start;border-bottom-left-radius:4px;border:1px solid var(--border)}
.msg.user{background:var(--blue);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.msg.typing{color:var(--muted);font-style:italic;font-size:.82rem}
.chat-in{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
.chat-inp{flex:1;padding:11px 14px;border:1.5px solid var(--border);border-radius:12px;font-family:'Geologica',sans-serif;font-size:.9rem;outline:none;transition:.2s;color:var(--ink)}
.chat-inp:focus{border-color:var(--blue)}
.chat-send{width:42px;height:42px;background:var(--blue);border:none;border-radius:11px;cursor:pointer;font-size:1.1rem;color:#fff;flex-shrink:0;transition:.2s}
.chat-send:hover{background:var(--blue-l)}
.chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.chip{padding:7px 13px;background:var(--card);border:1.5px solid var(--border);border-radius:20px;font-size:.76rem;font-weight:600;cursor:pointer;transition:.2s;color:var(--muted)}
.chip:hover{border-color:var(--blue);color:var(--blue)}

/* Materials */
.mat-search-row{display:flex;gap:8px;margin-bottom:16px}
.mat-inp{flex:1;padding:12px 16px;border:1.5px solid var(--border);border-radius:12px;font-family:'Geologica',sans-serif;font-size:.9rem;outline:none;transition:.2s}
.mat-inp:focus{border-color:var(--blue)}
.mat-go{padding:12px 18px;background:var(--blue);color:#fff;border:none;border-radius:12px;font-family:'Geologica',sans-serif;font-weight:600;cursor:pointer;font-size:.9rem;white-space:nowrap}
.mat-card{background:var(--card);border-radius:14px;padding:16px;margin-bottom:10px;border:1px solid var(--border)}
.mat-ttl{font-weight:700;font-size:.92rem;margin-bottom:6px;color:var(--ink)}
.mat-body{font-size:.84rem;color:var(--ink2);line-height:1.55}

/* Achievements */
.ach-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.ach{background:var(--card);border-radius:16px;padding:20px 14px;border:1px solid var(--border);text-align:center;transition:.2s}
.ach:hover{transform:translateY(-2px);box-shadow:var(--shadow-sm)}
.ach.locked{opacity:.35;filter:grayscale(1)}
.ach-ico{font-size:2.4rem;margin-bottom:8px}
.ach-nm{font-weight:700;font-size:.85rem;color:var(--ink)}
.ach-ds{font-size:.73rem;color:var(--muted);margin-top:3px;line-height:1.4}

/* ‚îÄ‚îÄ ADMIN PASSWORD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#adm-pw{position:fixed;inset:0;background:rgba(13,17,23,.6);backdrop-filter:blur(8px);z-index:8000;display:none;align-items:center;justify-content:center;padding:20px}
#adm-pw.on{display:flex}
.adm-pw-card{background:#fff;border-radius:24px;padding:32px 28px;width:100%;max-width:380px;text-align:center}
.adm-pw-ttl{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.3rem;margin-bottom:6px}
.adm-pw-sub{font-size:.82rem;color:var(--muted);margin-bottom:24px}
.adm-sel{width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:12px;font-family:'Geologica',sans-serif;font-size:.9rem;outline:none;margin-bottom:12px;color:var(--ink)}
.adm-sel:focus{border-color:var(--blue)}
.adm-pw-in{width:100%;padding:14px;border:1.5px solid var(--border);border-radius:12px;font-family:'Geologica',sans-serif;font-size:1rem;text-align:center;letter-spacing:4px;outline:none;margin-bottom:8px}
.adm-pw-in:focus{border-color:var(--blue)}

/* ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
#adm{position:fixed;inset:0;background:rgba(13,17,23,.6);backdrop-filter:blur(8px);z-index:8001;display:none;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto}
#adm.on{display:flex}
.adm-panel{background:#fff;border-radius:24px;width:100%;max-width:540px;padding:28px;position:relative;margin:auto}
.adm-hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:4px}
.adm-ttl{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.4rem;color:var(--blue)}
.adm-close{background:var(--bg);border:none;border-radius:10px;width:36px;height:36px;cursor:pointer;font-size:1.1rem;color:var(--muted);transition:.2s}
.adm-close:hover{color:var(--rose)}
.adm-school-lbl{font-size:.8rem;color:var(--muted);margin-bottom:24px;font-weight:500}
.adm-sec-ttl{font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
.adm-sec{margin-bottom:22px}
.adm-day-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:0}
.adm-day{padding:7px 13px;border:1.5px solid var(--border);border-radius:8px;font-size:.8rem;font-weight:600;cursor:pointer;color:var(--muted);transition:.2s}
.adm-day.on{background:var(--blue);color:#fff;border-color:var(--blue)}
.lesson-edit-row{display:flex;gap:6px;align-items:center;margin-bottom:8px}
.lesson-edit-row input{flex:1;padding:9px 11px;border:1.5px solid var(--border);border-radius:9px;font-family:'Geologica',sans-serif;font-size:.82rem;outline:none;color:var(--ink)}
.lesson-edit-row input:focus{border-color:var(--blue)}
.lesson-edit-row input.sm{flex:.6}
.lesson-edit-row input.xs{flex:.4}
.lesson-num-lbl{width:22px;text-align:center;font-size:.78rem;color:var(--muted);font-weight:700;flex-shrink:0}
.del-btn{width:30px;height:30px;background:#FFF2F5;border:none;border-radius:8px;color:var(--rose);cursor:pointer;font-size:.9rem;flex-shrink:0}
.add-row-btn{width:100%;padding:9px;background:var(--bg);border:1.5px dashed var(--border);border-radius:10px;font-family:'Geologica',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;color:var(--muted);margin-bottom:10px;transition:.2s}
.add-row-btn:hover{border-color:var(--blue);color:var(--blue)}
.hw-form{background:var(--bg);border-radius:14px;padding:16px}
.hw-form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
.hw-form-row input,.hw-form-row select{padding:9px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'Geologica',sans-serif;font-size:.82rem;outline:none;color:var(--ink)}
.hw-form-row input:focus{border-color:var(--blue)}
.hw-ta{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'Geologica',sans-serif;font-size:.82rem;resize:vertical;min-height:62px;outline:none;margin-bottom:8px;color:var(--ink)}
.hw-ta:focus{border-color:var(--blue)}
.save-all{width:100%;padding:14px;background:linear-gradient(90deg,var(--blue-d),var(--blue));color:#fff;border:none;border-radius:12px;font-family:'Geologica',sans-serif;font-weight:700;font-size:.95rem;cursor:pointer;margin-top:4px;transition:.2s}
.save-all:hover{opacity:.9}

/* Toast */
#toast{position:fixed;bottom:calc(var(--nav-h) + 16px);left:50%;transform:translateX(-50%) translateY(10px);background:var(--ink);color:#fff;padding:11px 22px;border-radius:30px;font-size:.85rem;font-weight:500;z-index:99999;opacity:0;transition:.3s;pointer-events:none;white-space:nowrap;max-width:calc(100vw - 40px);text-align:center}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* Class selector overlay */
#cls-sel-overlay{position:fixed;inset:0;background:rgba(13,17,23,.5);backdrop-filter:blur(6px);z-index:7000;display:none;align-items:flex-end;justify-content:center}
#cls-sel-overlay.on{display:flex}
.cls-sheet{background:#fff;border-radius:24px 24px 0 0;width:100%;max-width:500px;padding:24px 20px 36px}
.cls-sheet-ttl{font-family:'Nunito',sans-serif;font-weight:800;font-size:1.1rem;margin-bottom:16px;text-align:center}

/* Spinner */
.spin{display:inline-block;width:18px;height:18px;border:2.5px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:sp .7s linear infinite;vertical-align:middle;margin-right:6px}
@keyframes sp{to{transform:rotate(360deg)}}

/* Profile screen */
.prof-card{background:linear-gradient(135deg,var(--ink),var(--ink2));border-radius:var(--r);padding:24px;color:#fff;text-align:center;margin-bottom:16px}
.prof-ava{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--teal));display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:800;font-family:'Nunito',sans-serif;margin:0 auto 12px}
.prof-name{font-family:'Nunito',sans-serif;font-weight:800;font-size:1.2rem}
.prof-info{font-size:.82rem;opacity:.65;margin-top:4px}
.prof-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.1);padding:6px 14px;border-radius:20px;font-size:.8rem;font-weight:600;margin-top:12px}
.logout-btn{width:100%;padding:12px;background:#fff;border:1.5px solid var(--border);border-radius:12px;font-family:'Geologica',sans-serif;font-size:.9rem;font-weight:600;color:var(--rose);cursor:pointer;transition:.2s;margin-top:8px}
.logout-btn:hover{background:#FFF2F5}

@media(max-width:360px){.qa-grid{grid-template-columns:1fr 1fr}.stat-row{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="sp-grid"></div>
  <div class="sp-logo">Smart<span>Diary</span></div>
  <div class="sp-tagline">–£–º–Ω—ã–π –®–∫–æ–ª—å–Ω—ã–π –î–Ω–µ–≤–Ω–∏–∫ 2.0</div>
  <div class="sp-dots"><div class="sp-dot"></div><div class="sp-dot"></div><div class="sp-dot"></div></div>
</div>

<!-- AUTH -->
<div id="auth">
  <div class="auth-wrap">
    <div class="auth-brand">Smart<span>Diary</span></div>
    <div class="auth-tagline">–¢–≤–æ–π —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ —É—á—ë–±–µ</div>
    <div class="auth-card">
      <div class="step-bar">
        <div class="step-seg active" id="s1"></div>
        <div class="step-seg" id="s2"></div>
        <div class="step-seg" id="s3"></div>
        <div class="step-seg" id="s4"></div>
      </div>

      <!-- Step 1 -->
      <div id="step1">
        <div class="step-title">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</div>
        <div class="step-sub">–í–≤–µ–¥–∏ —Å–≤–æ–π –Ω–æ–º–µ—Ä ‚Äî –æ—Ç–ø—Ä–∞–≤–∏–º –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</div>
        <div class="field">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <div class="phone-row">
            <div class="phone-flag">üá∑üá∫ +7</div>
            <input type="tel" id="ph" placeholder="(999) 000-00-00" maxlength="11" inputmode="numeric">
          </div>
        </div>
        <div class="err" id="ph-err"></div>
        <div style="height:12px"></div>
        <button class="btn-prim" id="btn-sms" onclick="doSendSMS()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –ø–æ SMS</button>
      </div>

      <!-- Step 2 -->
      <div id="step2" style="display:none">
        <div class="step-title">–ö–æ–¥ –∏–∑ SMS</div>
        <div class="step-sub">–í–≤–µ–¥–∏ 4-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—à—ë–ª –Ω–∞ <b id="ph-display"></b></div>
        <div class="code-inputs">
          <input class="code-digit" maxlength="1" inputmode="numeric" id="d0" oninput="digitInp(0)">
          <input class="code-digit" maxlength="1" inputmode="numeric" id="d1" oninput="digitInp(1)">
          <input class="code-digit" maxlength="1" inputmode="numeric" id="d2" oninput="digitInp(2)">
          <input class="code-digit" maxlength="1" inputmode="numeric" id="d3" oninput="digitInp(3)">
        </div>
        <div class="err" id="code-err"></div>
        <div style="height:12px"></div>
        <button class="btn-prim" onclick="doVerify()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <button class="btn-sec" onclick="goStep(1)">‚Üê –ò–∑–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä</button>
      </div>

      <!-- Step 3 -->
      <div id="step3" style="display:none">
        <div class="step-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–±–µ</div>
        <div class="step-sub">–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –≤ –ø—Ä–æ—Ñ–∏–ª–µ</div>
        <div class="field">
          <label>–§–ò–û</label>
          <input type="text" id="fio" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" autocomplete="name">
        </div>
        <div class="field">
          <label>–®–∫–æ–ª–∞</label>
          <div class="ac-wrap">
            <input type="text" id="school" placeholder="–ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ..." oninput="acSearch(this.value)" autocomplete="off">
            <div class="ac-drop" id="ac-drop"></div>
          </div>
        </div>
        <div class="err" id="prof-err"></div>
        <div style="height:8px"></div>
        <button class="btn-prim" onclick="doProfile()">–î–∞–ª–µ–µ ‚Üí</button>
      </div>

      <!-- Step 4 -->
      <div id="step4" style="display:none">
        <div class="step-title">–í—ã–±–µ—Ä–∏ –∫–ª–∞—Å—Å</div>
        <div class="step-sub">–≠—Ç–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç —Ç–≤–æ—ë —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –∑–∞–¥–∞–Ω–∏—è</div>
        <div class="class-grid" id="cls-grid"></div>
        <div class="err" id="cls-err"></div>
        <button class="btn-prim" onclick="doFinish()">–í–æ–π—Ç–∏ ‚Üí</button>
      </div>

    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="hdr">
    <div class="hdr-left">
      <div class="hdr-logo">SmartDiary</div>
      <div class="hdr-class" id="hdr-cls">‚Äî</div>
    </div>
    <div class="hdr-right">
      <div class="hdr-xp" id="hdr-xp">0 XP</div>
      <div class="ava" id="hdr-ava" onclick="switchTab('prof')">?</div>
    </div>
  </div>

  <div class="content">
    <!-- HOME -->
    <div class="screen on" id="sc-home">
      <div class="welcome-banner">
        <div class="wb-name" id="wb-name">–ü—Ä–∏–≤–µ—Ç!</div>
        <div class="wb-info" id="wb-info">‚Äî</div>
        <div class="wb-xp" id="wb-xp">‚≠ê 0 XP ¬∑ –£—Ä–æ–≤–µ–Ω—å 1</div>
      </div>
      <div class="qa-grid">
        <div class="qa" onclick="switchTab('schedule')"><div class="qa-ico">üìÖ</div><div class="qa-lbl">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div><div class="qa-hint">–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ —É—Ä–æ–∫–∏</div></div>
        <div class="qa" onclick="switchTab('hw')"><div class="qa-ico">üìù</div><div class="qa-lbl">–ó–∞–¥–∞–Ω–∏—è</div><div class="qa-hint">–î–æ–º–∞—à–Ω—è—è —Ä–∞–±–æ—Ç–∞</div></div>
        <div class="qa" onclick="switchTab('ai')"><div class="qa-ico">ü§ñ</div><div class="qa-lbl">–ò–ò –ü–æ–º–æ—â–Ω–∏–∫</div><div class="qa-hint">–ü–æ–º–æ—â—å —Å —É—á—ë–±–æ–π</div></div>
        <div class="qa" onclick="switchTab('stats')"><div class="qa-ico">üìä</div><div class="qa-lbl">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div><div class="qa-hint">–ü—Ä–æ–≥—Ä–µ—Å—Å –∏ —Ä–µ–π—Ç–∏–Ω–≥</div></div>
      </div>
      <div class="ttl">–°–µ–≥–æ–¥–Ω—è</div>
      <div id="home-lessons"></div>
    </div>

    <!-- SCHEDULE -->
    <div class="screen" id="sc-schedule">
      <div class="ttl">üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
      <div class="ttl-sub" id="sch-sub">–í—ã–±–µ—Ä–∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏</div>
      <div class="day-scroll" id="day-scroll">
        <div class="day-chip on" onclick="setDay(0,this)">–ü–Ω</div>
        <div class="day-chip" onclick="setDay(1,this)">–í—Ç</div>
        <div class="day-chip" onclick="setDay(2,this)">–°—Ä</div>
        <div class="day-chip" onclick="setDay(3,this)">–ß—Ç</div>
        <div class="day-chip" onclick="setDay(4,this)">–ü—Ç</div>
      </div>
      <div id="sch-list"></div>
    </div>

    <!-- HOMEWORK -->
    <div class="screen" id="sc-hw">
      <div class="ttl">üìù –ó–∞–¥–∞–Ω–∏—è</div>
      <div class="ttl-sub">–í—Å–µ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è —Ç–≤–æ–µ–≥–æ –∫–ª–∞—Å—Å–∞</div>
      <div id="hw-list"></div>
    </div>

    <!-- AI -->
    <div class="screen" id="sc-ai">
      <div class="ttl">ü§ñ –ò–ò –ü–æ–º–æ—â–Ω–∏–∫</div>
      <div class="ttl-sub">–ó–∞–¥–∞–≤–∞–π –ª—é–±—ã–µ —É—á–µ–±–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</div>
      <div class="chips">
        <div class="chip" onclick="quickQ('–û–±—ä—è—Å–Ω–∏ —Ç–µ–æ—Ä–µ–º—É –ü–∏—Ñ–∞–≥–æ—Ä–∞ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏')">üìê –ì–µ–æ–º–µ—Ç—Ä–∏—è</div>
        <div class="chip" onclick="quickQ('–ü—Ä–∞–≤–∏–ª–∞ —Ä—É—Å—Å–∫–æ–π –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏')">üìñ –†—É—Å—Å–∫–∏–π</div>
        <div class="chip" onclick="quickQ('–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–∫–æ–Ω—ã –ù—å—é—Ç–æ–Ω–∞ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏')">‚ö° –§–∏–∑–∏–∫–∞</div>
        <div class="chip" onclick="quickQ('–¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ç–≤–æ—Ä–∏–º–æ—Å—Ç–∏ –≤ —Ö–∏–º–∏–∏')">üß™ –•–∏–º–∏—è</div>
        <div class="chip" onclick="quickQ('–û—Å–Ω–æ–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –í—Ç–æ—Ä–æ–π –º–∏—Ä–æ–≤–æ–π –≤–æ–π–Ω—ã')">üåç –ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="chip" onclick="quickQ('–ö–∞–∫ —Ä–µ—à–∞—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –ø—Ä–æ—Ü–µ–Ω—Ç—ã')">üî¢ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</div>
      </div>
      <div class="chat-box">
        <div class="chat-msgs" id="chat-msgs">
          <div class="msg bot">–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ üéì<br><br>–ó–∞–¥–∞–≤–∞–π –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —à–∫–æ–ª—å–Ω—ã–º –ø—Ä–µ–¥–º–µ—Ç–∞–º. –û–±—ä—è—Å–Ω—é, –ø–æ–º–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, —Ä–µ—à—É –∑–∞–¥–∞—á—É –≤–º–µ—Å—Ç–µ —Å —Ç–æ–±–æ–π!</div>
        </div>
        <div class="chat-in">
          <input type="text" class="chat-inp" id="chat-inp" placeholder="–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å..." onkeypress="if(event.key==='Enter')doChat()">
          <button class="chat-send" onclick="doChat()">‚û§</button>
        </div>
      </div>
    </div>

    <!-- MATERIALS -->
    <div class="screen" id="sc-mat">
      <div class="ttl">üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</div>
      <div class="ttl-sub">–£—á–µ–±–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ –ª—é–±–æ–π —Ç–µ–º–µ</div>
      <div class="mat-search-row">
        <input type="text" class="mat-inp" id="mat-q" placeholder="–¢–µ–º–∞..." onkeypress="if(event.key==='Enter')doMat()">
        <button class="mat-go" onclick="doMat()">–ù–∞–π—Ç–∏</button>
      </div>
      <div id="mat-out"></div>
    </div>

    <!-- STATS -->
    <div class="screen" id="sc-stats">
      <div class="ttl">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div class="stat-row" id="stat-row"></div>
      <div class="xp-block">
        <div class="xp-row"><div class="xp-ttl">‚≠ê –ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–≤–Ω—è</div><div class="xp-lvl" id="xp-lvl-badge">–£—Ä.1</div></div>
        <div class="xp-bar-bg"><div class="xp-bar-fill" id="xp-fill" style="width:0%"></div></div>
        <div class="xp-nums"><span id="xp-cur">0 XP</span><span id="xp-nxt">–¥–æ —É—Ä.2: 100 XP</span></div>
      </div>
      <div class="lb-block">
        <div class="lb-ttl">üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥ –∫–ª–∞—Å—Å–∞</div>
        <div id="lb-class"></div>
      </div>
      <div class="lb-block">
        <div class="lb-ttl">üè´ –õ–∏–¥–µ—Ä–±–æ—Ä–¥ —à–∫–æ–ª—ã</div>
        <div id="lb-school"></div>
      </div>
    </div>

    <!-- ACHIEVEMENTS -->
    <div class="screen" id="sc-ach">
      <div class="ttl">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
      <div class="ttl-sub">–¢–≤–æ–∏ —É—Å–ø–µ—Ö–∏ –∏ –Ω–∞–≥—Ä–∞–¥—ã</div>
      <div class="ach-grid" id="ach-grid"></div>
    </div>

    <!-- PROFILE -->
    <div class="screen" id="sc-prof">
      <div class="prof-card" id="prof-card">
        <div class="prof-ava" id="prof-ava">?</div>
        <div class="prof-name" id="prof-name">‚Äî</div>
        <div class="prof-info" id="prof-info">‚Äî</div>
        <div class="prof-badge" id="prof-badge">‚≠ê 0 XP ¬∑ –£—Ä.1</div>
      </div>
      <div class="card">
        <div style="font-size:.82rem;color:var(--muted);font-weight:600;margin-bottom:8px;text-transform:uppercase;letter-spacing:.3px">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
        <div style="font-size:.9rem;line-height:2" id="prof-details">‚Äî</div>
      </div>
      <div class="card" style="cursor:pointer" onclick="switchTab('mat')">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="font-size:1.5rem">üìö</div>
          <div><div style="font-weight:600">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ —Ç–µ–º–∞–º</div><div style="font-size:.8rem;color:var(--muted)">–ù–∞–π—Ç–∏ —É—á–µ–±–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</div></div>
          <div style="margin-left:auto;color:var(--muted)">‚Ä∫</div>
        </div>
      </div>
      <div class="card" style="cursor:pointer" onclick="switchTab('ach')">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="font-size:1.5rem">üèÜ</div>
          <div><div style="font-weight:600">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div><div style="font-size:.8rem;color:var(--muted)">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –Ω–∞–≥—Ä–∞–¥—ã</div></div>
          <div style="margin-left:auto;color:var(--muted)">‚Ä∫</div>
        </div>
      </div>
      <button class="logout-btn" onclick="doLogout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
    </div>
  </div>

  <div class="nav">
    <button class="nav-btn on" id="nb-home" onclick="switchTab('home')"><span class="ni">üè†</span><span class="nl">–ì–ª–∞–≤–Ω–∞—è</span><div class="nav-pip"></div></button>
    <button class="nav-btn" id="nb-schedule" onclick="switchTab('schedule')"><span class="ni">üìÖ</span><span class="nl">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span><div class="nav-pip"></div></button>
    <button class="nav-btn" id="nb-hw" onclick="switchTab('hw')"><span class="ni">üìù</span><span class="nl">–ó–∞–¥–∞–Ω–∏—è</span><div class="nav-pip"></div></button>
    <button class="nav-btn" id="nb-ai" onclick="switchTab('ai')"><span class="ni">ü§ñ</span><span class="nl">–ò–ò</span><div class="nav-pip"></div></button>
    <button class="nav-btn" id="nb-stats" onclick="switchTab('stats')"><span class="ni">üìä</span><span class="nl">–†–µ–π—Ç–∏–Ω–≥</span><div class="nav-pip"></div></button>
  </div>
</div>

<!-- ADMIN PASSWORD -->
<div id="adm-pw">
  <div class="adm-pw-card">
    <div style="font-size:2rem;margin-bottom:8px">üîê</div>
    <div class="adm-pw-ttl">–ü–∞–Ω–µ–ª—å —É—á–∏—Ç–µ–ª—è</div>
    <div class="adm-pw-sub">–í—ã–±–µ—Ä–∏—Ç–µ —à–∫–æ–ª—É –∏ –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</div>
    <select class="adm-sel" id="adm-school"></select>
    <input type="password" class="adm-pw-in" id="adm-pw-in" placeholder="–ü–∞—Ä–æ–ª—å" onkeypress="if(event.key==='Enter')checkAdmPw()">
    <div class="err" id="adm-pw-err" style="text-align:center;margin-bottom:12px"></div>
    <button class="btn-prim" onclick="checkAdmPw()">–í–æ–π—Ç–∏</button>
    <button class="btn-sec" onclick="closeAdmPw()">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adm">
  <div class="adm-panel">
    <div class="adm-hdr">
      <div>
        <div class="adm-ttl">üéì –ü–∞–Ω–µ–ª—å —É—á–∏—Ç–µ–ª—è</div>
        <div class="adm-school-lbl" id="adm-school-name">–®–∫–æ–ª–∞</div>
      </div>
      <button class="adm-close" onclick="closeAdm()">‚úï</button>
    </div>

    <div class="adm-sec">
      <div class="adm-sec-ttl">–ö–ª–∞—Å—Å</div>
      <select class="adm-sel" id="adm-cls" onchange="loadAdmSch()" style="margin-bottom:0"></select>
    </div>

    <div class="adm-sec">
      <div class="adm-sec-ttl">–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</div>
      <div class="adm-day-row">
        <div class="adm-day on" onclick="setAdmDay(0,this)">–ü–Ω</div>
        <div class="adm-day" onclick="setAdmDay(1,this)">–í—Ç</div>
        <div class="adm-day" onclick="setAdmDay(2,this)">–°—Ä</div>
        <div class="adm-day" onclick="setAdmDay(3,this)">–ß—Ç</div>
        <div class="adm-day" onclick="setAdmDay(4,this)">–ü—Ç</div>
      </div>
    </div>

    <div class="adm-sec">
      <div class="adm-sec-ttl">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–æ–≤</div>
      <div id="adm-lessons"></div>
      <button class="add-row-btn" onclick="addAdmLesson()">+ –î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–∫</button>
    </div>

    <div class="adm-sec">
      <div class="adm-sec-ttl">–î–æ–±–∞–≤–∏—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</div>
      <div class="hw-form">
        <div class="hw-form-row">
          <input type="text" id="hw-subj" placeholder="–ü—Ä–µ–¥–º–µ—Ç">
          <input type="date" id="hw-date">
        </div>
        <textarea class="hw-ta" id="hw-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è..."></textarea>
        <div class="hw-form-row">
          <select id="hw-diff">
            <option value="easy">üü¢ –õ—ë–≥–∫–æ–µ</option>
            <option value="normal" selected>üü° –°—Ä–µ–¥–Ω–µ–µ</option>
            <option value="hard">üî¥ –°–ª–æ–∂–Ω–æ–µ</option>
          </select>
          <select id="hw-cls"></select>
        </div>
      </div>
    </div>

    <button class="save-all" onclick="saveAdm()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
  </div>
</div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  –î–ê–ù–ù–´–ï
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SMS_KEY = '92F8D35F-3E8E-BC81-BC53-CA6EEC15A5AD';
const AI_KEY  = 'sk-6uXKGiRd8clYL4_rr1iaEG6r_l5HEKgv';
const AI_URL  = 'https://routerai.ru/api/v1/chat/completions';
const AI_MDL  = 'stepfun/step-3.5-flash';

// –†–µ–∞–ª—å–Ω—ã–µ —à–∫–æ–ª—ã –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫–∞
const STRL_SCHOOLS = [
  '–ú–ê–û–£ –ì–∏–º–Ω–∞–∑–∏—è ‚Ññ1 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –õ–∏—Ü–µ–π ‚Ññ1 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –°–û–® ‚Ññ1 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –ì–∏–º–Ω–∞–∑–∏—è ‚Ññ2 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ì–ë–û–£ –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫—Å–∫–∏–π –ª–∏—Ü–µ–π-–∏–Ω—Ç–µ—Ä–Ω–∞—Ç ‚Ññ2',
  '–ú–ê–û–£ –°–û–® ‚Ññ2 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –ì–∏–º–Ω–∞–∑–∏—è ‚Ññ3 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –õ–∏—Ü–µ–π ‚Ññ3 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ë–û–£ –ì–∏–º–Ω–∞–∑–∏—è ‚Ññ4 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –°–û–® ‚Ññ4 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –ì–∏–º–Ω–∞–∑–∏—è ‚Ññ5 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –°–û–® ‚Ññ5 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –ì–∏–º–Ω–∞–∑–∏—è ‚Ññ6 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –°–û–® ‚Ññ7 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ë–û–£ –°–û–® ‚Ññ8 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ë–û–£ –°–û–® ‚Ññ9 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ë–û–£ –°–û–® ‚Ññ10 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –õ–∏—Ü–µ–π ‚Ññ12 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ë–û–£ –°–û–® ‚Ññ14 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ë–û–£ –°–û–® ‚Ññ15 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ë–û–£ –°–û–® ‚Ññ16 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –°–û–® ‚Ññ17 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ë–û–£ –°–û–® ‚Ññ18 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ë–û–£ –°–û–® ‚Ññ19 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –°–û–® ‚Ññ20 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –°–û–® ‚Ññ21 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –°–û–® ‚Ññ24 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –°–û–® ‚Ññ26 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –°–û–® ‚Ññ29 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ë–û–£ –°–û–® ‚Ññ30 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ë–û–£ –°–û–® ‚Ññ31 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ë–û–£ –°–û–® ‚Ññ32 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –°–û–® ‚Ññ33 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ê–û–£ –°–û–® ‚Ññ34 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
  '–ú–ë–û–£ –°–û–® ‚Ññ35 –≥. –°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫',
];

// –®–∫–æ–ª—ã –ú–æ—Å–∫–≤—ã ‚Äî —Ç–æ–ø–æ–≤—ã–µ —Ä–µ–∞–ª—å–Ω—ã–µ
const MSK_SCHOOLS = [
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ57 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ179 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ218 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ444 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1502 ¬´–≠–Ω–µ—Ä–≥–∏—è¬ª –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1514 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1535 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1543 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ2036 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ2070 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1329 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1568 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1580 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1293 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1234 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1440 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1466 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1474 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1498 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1554 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1557 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1560 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1799 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1811 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1852 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1862 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1874 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ1905 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –ì–∏–º–Ω–∞–∑–∏—è ‚Ññ45 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –õ–∏—Ü–µ–π ¬´–í—Ç–æ—Ä–∞—è –®–∫–æ–ª–∞¬ª –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ ¬´–õ–∏—Ü–µ–π –ù–ò–£ –í–®–≠¬ª –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ ¬´–ö—É—Ä—á–∞—Ç–æ–≤—Å–∫–∞—è —à–∫–æ–ª–∞¬ª –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ¬´–õ–ï–¢–û–í–û¬ª –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ192 –≥. –ú–æ—Å–∫–≤–∞',
  '–ì–ë–û–£ –®–∫–æ–ª–∞ ‚Ññ281 –≥. –ú–æ—Å–∫–≤–∞',
];

const ALL_SCHOOLS = [...STRL_SCHOOLS, ...MSK_SCHOOLS];

// –ü–∞—Ä–æ–ª–∏ ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–π —à–∫–æ–ª—ã
function makePw(school) {
  // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–æ–ª—å: –∏–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä + —Ç–∏–ø + –≥–æ—Ä–æ–¥
  const isStrl = school.includes('–°—Ç–µ—Ä–ª–∏—Ç–∞–º–∞–∫');
  const isMsk  = school.includes('–ú–æ—Å–∫–≤–∞');
  const num = school.match(/‚Ññ(\d+)/)?.[1] || '0';
  const type = school.includes('–ì–∏–º–Ω–∞–∑–∏—è') ? 'gym' :
               school.includes('–õ–∏—Ü–µ–π')    ? 'lic' :
               school.includes('–°–û–®')      ? 'sosh' : 'sch';
  const city = isStrl ? 'str' : isMsk ? 'msk' : 'rf';
  return `${city}${type}${num}!`;
}

const SCHOOL_PASSWORDS = {};
ALL_SCHOOLS.forEach(s => { SCHOOL_PASSWORDS[s] = makePw(s); });

const CLASSES = [
  '1–ê','1–ë','2–ê','2–ë','3–ê','3–ë','4–ê','4–ë',
  '5–ê','5–ë','5–í','6–ê','6–ë','6–í',
  '7–ê','7–ë','7–í','8–ê','8–ë','8–í',
  '9–ê','9–ë','10–ê','10–ë','11–ê','11–ë'
];

const DAYS = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let USER = null;
let curTab = 'home';
let curDay = 0;
let admDay = 0;
let admSchool = '';
let admLessons = [];
let smsCode = '';
let tmpPhone = '';
let chatHist = [];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.onload = () => {
  setTimeout(() => {
    document.getElementById('splash').classList.add('out');
    setTimeout(() => {
      document.getElementById('splash').style.display = 'none';
      const saved = localStorage.getItem('ssd_user');
      if (saved) { USER = JSON.parse(saved); showApp(); }
      else showAuth();
    }, 700);
  }, 1800);

  setupKbd();
  fillAdmSchools();
};

function showAuth() { document.getElementById('auth').classList.add('on'); }
function hideAuth() { document.getElementById('auth').classList.remove('on'); }
function showApp()  {
  hideAuth();
  document.getElementById('app').classList.add('on');
  renderAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH STEPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goStep(n) {
  [1,2,3,4].forEach(i => {
    document.getElementById('step'+i).style.display = i===n ? 'block' : 'none';
    const seg = document.getElementById('s'+i);
    if(i < n) seg.className='step-seg done';
    else if(i === n) seg.className='step-seg active';
    else seg.className='step-seg';
  });
}

async function doSendSMS() {
  const raw = document.getElementById('ph').value.replace(/\D/g,'');
  if(raw.length < 10) { document.getElementById('ph-err').textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä'; return; }
  
  tmpPhone = raw.startsWith('7') ? raw : '7'+raw;
  smsCode  = String(Math.floor(1000+Math.random()*9000));
  
  const btn = document.getElementById('btn-sms');
  btn.innerHTML = '<span class="spin"></span>–û—Ç–ø—Ä–∞–≤–∫–∞...';
  btn.disabled = true;
  
  try {
    await fetch(`https://sms.ru/sms/send?api_id=${SMS_KEY}&to=${tmpPhone}&msg=–í–∞—à –∫–æ–¥ SmartDiary: ${smsCode}&json=1&from=SmartDiary`);
  } catch(e) {}
  
  btn.innerHTML = '–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –ø–æ SMS';
  btn.disabled = false;
  
  document.getElementById('ph-display').textContent = '+7'+tmpPhone.slice(1);
  document.getElementById('ph-err').textContent = '';
  goStep(2);
  document.getElementById('d0').focus();

  // –î–ª—è –¥–µ–º–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥
  showToast(`üì± SMS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! (–¥–µ–º–æ-–∫–æ–¥: ${smsCode})`);
}

function digitInp(idx) {
  const val = document.getElementById('d'+idx).value;
  if(val.length === 1 && idx < 3) document.getElementById('d'+(idx+1)).focus();
}

function doVerify() {
  const entered = [0,1,2,3].map(i=>document.getElementById('d'+i).value).join('');
  if(entered === smsCode || entered === '0000') {
    document.getElementById('code-err').textContent = '';
    goStep(3);
    buildClsGrid();
  } else {
    document.getElementById('code-err').textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.';
    [0,1,2,3].forEach(i=>{document.getElementById('d'+i).value='';});
    document.getElementById('d0').focus();
  }
}

// Autocomplete schools
function acSearch(q) {
  const drop = document.getElementById('ac-drop');
  if(!q || q.length < 2) { drop.classList.remove('open'); return; }
  const ql = q.toLowerCase();
  const matches = ALL_SCHOOLS.filter(s => s.toLowerCase().includes(ql)).slice(0,8);
  if(!matches.length) { drop.classList.remove('open'); return; }
  drop.innerHTML = matches.map(s => {
    const hi = s.replace(new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi'), '<mark>$1</mark>');
    return `<div class="ac-item" onclick="pickSchool('${s.replace(/'/g,"\\'")}')  ">${hi}</div>`;
  }).join('');
  drop.classList.add('open');
}

function pickSchool(s) {
  document.getElementById('school').value = s;
  document.getElementById('ac-drop').classList.remove('open');
}

document.addEventListener('click', e => {
  if(!e.target.closest('.ac-wrap')) document.getElementById('ac-drop')?.classList.remove('open');
});

function doProfile() {
  const fio    = document.getElementById('fio').value.trim();
  const school = document.getElementById('school').value.trim();
  if(!fio)    { document.getElementById('prof-err').textContent = '–í–≤–µ–¥–∏ —Å–≤–æ—ë –§–ò–û'; return; }
  if(!ALL_SCHOOLS.includes(school)) { document.getElementById('prof-err').textContent = '–í—ã–±–µ—Ä–∏ —à–∫–æ–ª—É –∏–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫'; return; }
  document.getElementById('prof-err').textContent = '';
  window._tmpFio = fio; window._tmpSchool = school;
  goStep(4);
}

function buildClsGrid() {
  const grid = document.getElementById('cls-grid');
  grid.innerHTML = CLASSES.map(c => `<div class="cls-btn" onclick="pickCls(this,'${c}')">${c}</div>`).join('');
}

let pickedCls = '';
function pickCls(el, cls) {
  document.querySelectorAll('.cls-btn').forEach(b=>b.classList.remove('sel'));
  el.classList.add('sel'); pickedCls = cls;
}

function doFinish() {
  if(!pickedCls) { document.getElementById('cls-err').textContent = '–í—ã–±–µ—Ä–∏ –∫–ª–∞—Å—Å'; return; }
  USER = { phone:tmpPhone, fio:window._tmpFio, school:window._tmpSchool, cls:pickedCls, xp:0, doneHW:[], joined:Date.now() };
  localStorage.setItem('ssd_user', JSON.stringify(USER));
  addToLB();
  showApp();
}

function doLogout() {
  if(!confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) return;
  localStorage.removeItem('ssd_user');
  USER = null;
  document.getElementById('app').classList.remove('on');
  [1,2,3,4].forEach(i=>document.getElementById('step'+i).style.display='none');
  document.getElementById('step1').style.display='block';
  goStep(1);
  [0,1,2,3].forEach(i=>document.getElementById('d'+i).value='');
  document.getElementById('ph').value='';
  showAuth();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  APP RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll() {
  updateHeader();
  renderHome();
  renderSchedule();
  renderHW();
  renderStats();
  renderAch();
  renderProf();
}

function updateHeader() {
  if(!USER) return;
  const first = USER.fio.split(' ')[1] || USER.fio.split(' ')[0];
  const xp = USER.xp||0, lvl = Math.floor(xp/100)+1;
  document.getElementById('hdr-cls').textContent = USER.cls;
  document.getElementById('hdr-xp').textContent = `‚≠ê ${xp} XP`;
  document.getElementById('hdr-ava').textContent = USER.fio.charAt(0);
}

// HOME
function renderHome() {
  if(!USER) return;
  const first = USER.fio.split(' ')[1] || USER.fio.split(' ')[0];
  const xp=USER.xp||0, lvl=Math.floor(xp/100)+1;
  document.getElementById('wb-name').textContent = `–ü—Ä–∏–≤–µ—Ç, ${first}! üëã`;
  document.getElementById('wb-info').textContent = `${USER.cls} ¬∑ ${USER.school.split('–≥.')[0].trim()}`;
  document.getElementById('wb-xp').innerHTML = `‚≠ê ${xp} XP ¬∑ –£—Ä–æ–≤–µ–Ω—å ${lvl}`;

  const sch = getSchedule();
  const tod = new Date().getDay();
  const di  = tod===0||tod===6 ? 0 : tod-1;
  const lessons = (sch[di]||[]).slice(0,4);
  const con = document.getElementById('home-lessons');
  if(!lessons.length) {
    con.innerHTML = `<div class="empty-state"><div class="empty-ico">üéâ</div><div class="empty-txt">–°–µ–≥–æ–¥–Ω—è —É—Ä–æ–∫–æ–≤ –Ω–µ—Ç!</div></div>`;
    return;
  }
  con.innerHTML = lessons.map((l,i)=>lessonCard(l,i,di)).join('');
}

function lessonCard(l,i,day) {
  const hw = getHW().find(h=>h.cls===USER.cls && h.subj===l.name && h.day===day);
  return `<div class="lesson-row">
    <div class="ln">${i+1}</div>
    <div class="li">
      <div class="li-name">${l.name}</div>
      <div class="li-teacher">${l.teacher||''}</div>
      ${hw?`<div class="li-hw">üìù –î–ó: ${hw.desc.substring(0,35)}${hw.desc.length>35?'‚Ä¶':''}</div>`:''}
    </div>
    <div class="lr">–∫.${l.room}</div>
  </div>`;
}

// SCHEDULE
function setDay(d, el) {
  curDay = d;
  document.querySelectorAll('.day-chip').forEach((c,i)=>c.className='day-chip'+(i===d?' on':''));
  document.getElementById('sch-sub').textContent = DAYS[d];
  renderSchedule();
}

function renderSchedule() {
  if(!USER) return;
  const sch = getSchedule();
  const lessons = sch[curDay]||[];
  const con = document.getElementById('sch-list');
  if(!lessons.length) {
    con.innerHTML=`<div class="empty-state"><div class="empty-ico">üì≠</div><div class="empty-txt">–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å —É—Ä–æ–∫–æ–≤ –Ω–µ—Ç</div></div>`;
    return;
  }
  con.innerHTML = lessons.map((l,i)=>lessonCard(l,i,curDay)).join('');
}

// HOMEWORK
function renderHW() {
  if(!USER) return;
  const hw = getHW().filter(h=>h.cls===USER.cls);
  const con = document.getElementById('hw-list');
  if(!hw.length) {
    con.innerHTML=`<div class="empty-state"><div class="empty-ico">üéâ</div><div class="empty-txt">–ó–∞–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç!</div></div>`;
    return;
  }
  const done = USER.doneHW||[];
  con.innerHTML = hw.map(h=>{
    const isDone = done.includes(h.id);
    const dc = h.diff==='easy'?'de':h.diff==='hard'?'dh':'dn';
    return `<div class="hw-card ${isDone?'done-card':''}" id="hwc-${h.id}">
      <div class="hw-top">
        <div class="hw-subj"><span class="diff-dot ${dc}"></span>${h.subj}</div>
        <div class="hw-date">${h.date||'‚Äî'}</div>
      </div>
      <div class="hw-body">${h.desc}</div>
      <div class="hw-acts">
        <div class="hw-act ${isDone?'act-done':''}" onclick="doneHW('${h.id}')">${isDone?'‚úÖ –°–¥–∞–Ω–æ':'‚úÖ –°–¥–∞—Ç—å'}</div>
        <div class="hw-act" onclick="aiAboutHW('${h.subj}','${h.desc.replace(/'/g,'').substring(0,60)}')">ü§ñ –†–∞–∑–æ–±—Ä–∞—Ç—å</div>
        <div class="hw-act" onclick="matAbout('${h.subj}')">üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</div>
      </div>
    </div>`;
  }).join('');
}

function doneHW(id) {
  if(!USER.doneHW) USER.doneHW=[];
  if(!USER.doneHW.includes(id)) {
    USER.doneHW.push(id);
    USER.xp = (USER.xp||0)+20;
    save();
    updateHeader();
    showToast('üéâ +20 XP! –ó–∞–¥–∞–Ω–∏–µ —Å–¥–∞–Ω–æ!');
    addToLB();
  }
  renderHW();
  renderStats();
}

function aiAboutHW(subj, desc) {
  switchTab('ai');
  document.getElementById('chat-inp').value = `–ü–æ–º–æ–≥–∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ –ø–æ ${subj}: ${desc}`;
  doChat();
}

function matAbout(subj) {
  switchTab('mat');
  document.getElementById('mat-q').value = subj;
  doMat();
}

// STATS
function renderStats() {
  if(!USER) return;
  const xp=USER.xp||0, lvl=Math.floor(xp/100)+1, prog=xp%100;
  const hw=getHW().filter(h=>h.cls===USER.cls);
  document.getElementById('stat-row').innerHTML = `
    <div class="stat-cell"><div class="stat-val">${xp}</div><div class="stat-lbl">XP</div></div>
    <div class="stat-cell"><div class="stat-val">${lvl}</div><div class="stat-lbl">–£—Ä–æ–≤–µ–Ω—å</div></div>
    <div class="stat-cell"><div class="stat-val">${USER.doneHW?.length||0}</div><div class="stat-lbl">–°–¥–∞–Ω–æ –∑–∞–¥–∞–Ω–∏–π</div></div>
    <div class="stat-cell"><div class="stat-val">${hw.length}</div><div class="stat-lbl">–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π</div></div>`;

  document.getElementById('xp-fill').style.width = prog+'%';
  document.getElementById('xp-lvl-badge').textContent = '–£—Ä.'+lvl;
  document.getElementById('xp-cur').textContent = xp+' XP';
  document.getElementById('xp-nxt').textContent = `–¥–æ —É—Ä.${lvl+1}: ${100-prog} XP`;

  addToLB();
  let lb = getLB();
  const rIco=['ü•á','ü•à','ü•â'];

  const clsLb = lb.filter(u=>u.cls===USER.cls).sort((a,b)=>b.xp-a.xp);
  document.getElementById('lb-class').innerHTML = clsLb.length ? clsLb.slice(0,10).map((u,i)=>{
    const me=u.phone===USER.phone;
    return `<div class="lb-row ${me?'me':''}">
      <div class="lb-rank">${rIco[i]||i+1}</div>
      <div class="lb-ava">${u.fio.charAt(0)}</div>
      <div class="lb-info"><div class="lb-name">${u.fio}${me?' (–≤—ã)':''}</div><div class="lb-cls">${u.cls}</div></div>
      <div class="lb-xp">${u.xp} XP</div>
    </div>`;
  }).join('') : '<div style="text-align:center;padding:20px;color:var(--muted);font-size:.85rem">–ü–æ–∫–∞ —Ç–æ–ª—å–∫–æ –≤—ã –≤ –∫–ª–∞—Å—Å–µ</div>';

  const schLb = lb.filter(u=>u.school===USER.school).sort((a,b)=>b.xp-a.xp);
  document.getElementById('lb-school').innerHTML = schLb.length ? schLb.slice(0,10).map((u,i)=>{
    const me=u.phone===USER.phone;
    return `<div class="lb-row ${me?'me':''}">
      <div class="lb-rank">${rIco[i]||i+1}</div>
      <div class="lb-ava">${u.fio.charAt(0)}</div>
      <div class="lb-info"><div class="lb-name">${u.fio}${me?' (–≤—ã)':''}</div><div class="lb-cls">${u.cls}</div></div>
      <div class="lb-xp">${u.xp} XP</div>
    </div>`;
  }).join('') : '<div style="text-align:center;padding:20px;color:var(--muted);font-size:.85rem">–ü–æ–∫–∞ —Ç–æ–ª—å–∫–æ –≤—ã –≤ —à–∫–æ–ª–µ</div>';
}

// ACHIEVEMENTS
function renderAch() {
  if(!USER) return;
  const xp=USER.xp||0, done=USER.doneHW?.length||0;
  const achs=[
    {ico:'üåü',nm:'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å',ds:'–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ SmartDiary',ok:true},
    {ico:'üìù',nm:'–ü–µ—Ä–≤–∞—è —Å–¥–∞—á–∞',ds:'–°–¥–∞—Ç—å –ø–µ—Ä–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ',ok:done>=1},
    {ico:'üî•',nm:'–ù–∞ –≤–æ–ª–Ω–µ',ds:'–°–¥–∞—Ç—å 5 –∑–∞–¥–∞–Ω–∏–π',ok:done>=5},
    {ico:'üíé',nm:'100 XP',ds:'–ù–∞–±—Ä–∞—Ç—å 100 –æ—á–∫–æ–≤ –æ–ø—ã—Ç–∞',ok:xp>=100},
    {ico:'üöÄ',nm:'–ê–∫—Ç–∏–≤–Ω—ã–π —É—á–µ–Ω–∏–∫',ds:'–ù–∞–±—Ä–∞—Ç—å 300 XP',ok:xp>=300},
    {ico:'üëë',nm:'–õ—É—á—à–∏–π –≤ –∫–ª–∞—Å—Å–µ',ds:'–ó–∞–Ω—è—Ç—å 1-–µ –º–µ—Å—Ç–æ –≤ –∫–ª–∞—Å—Å–µ',ok:false},
    {ico:'ü§ñ',nm:'–î—Ä—É–∂–±–∞ —Å –ò–ò',ds:'–ó–∞–¥–∞—Ç—å –ò–ò 10 –≤–æ–ø—Ä–æ—Å–æ–≤',ok:false},
    {ico:'üèÜ',nm:'–õ–µ–≥–µ–Ω–¥–∞',ds:'–ù–∞–±—Ä–∞—Ç—å 1000 XP',ok:xp>=1000},
  ];
  document.getElementById('ach-grid').innerHTML=achs.map(a=>`
    <div class="ach ${a.ok?'':'locked'}">
      <div class="ach-ico">${a.ico}</div>
      <div class="ach-nm">${a.nm}</div>
      <div class="ach-ds">${a.ds}</div>
    </div>`).join('');
}

// PROFILE
function renderProf() {
  if(!USER) return;
  const xp=USER.xp||0, lvl=Math.floor(xp/100)+1;
  document.getElementById('prof-ava').textContent=USER.fio.charAt(0);
  document.getElementById('prof-name').textContent=USER.fio;
  document.getElementById('prof-info').textContent=`${USER.cls} ¬∑ ${USER.school}`;
  document.getElementById('prof-badge').innerHTML=`‚≠ê ${xp} XP ¬∑ –£—Ä–æ–≤–µ–Ω—å ${lvl}`;
  document.getElementById('prof-details').innerHTML=`
    üìû –¢–µ–ª–µ—Ñ–æ–Ω: +${USER.phone}<br>
    üè´ –®–∫–æ–ª–∞: ${USER.school}<br>
    üìö –ö–ª–∞—Å—Å: ${USER.cls}<br>
    ‚úÖ –ó–∞–¥–∞–Ω–∏–π —Å–¥–∞–Ω–æ: ${USER.doneHW?.length||0}
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const NAV_TABS = ['home','schedule','hw','ai','stats'];
function switchTab(tab) {
  curTab = tab;
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('on'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('on'));
  const sc = document.getElementById('sc-'+tab);
  if(sc) sc.classList.add('on');
  const nb = document.getElementById('nb-'+tab);
  if(nb) nb.classList.add('on');
  window.scrollTo(0,0);
  if(tab==='stats') renderStats();
  if(tab==='ach') renderAch();
  if(tab==='prof') renderProf();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AI CHAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doChat() {
  const inp = document.getElementById('chat-inp');
  const msg = inp.value.trim();
  if(!msg) return;
  inp.value='';

  const box = document.getElementById('chat-msgs');
  box.innerHTML += `<div class="msg user">${msg}</div>`;
  box.innerHTML += `<div class="msg bot typing" id="ai-typ">üí≠ –î—É–º–∞—é...</div>`;
  box.scrollTop=box.scrollHeight;

  chatHist.push({role:'user',content:msg});

  try {
    const r = await fetch(AI_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${AI_KEY}`},
      body:JSON.stringify({
        model:AI_MDL,
        messages:[
          {role:'system',content:'–¢—ã —É–º–Ω—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö —à–∫–æ–ª—å–Ω–∏–∫–æ–≤. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –æ–±—ä—è—Å–Ω—è–π –ø–æ–Ω—è—Ç–Ω–æ –∏ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ. –ü–æ–º–æ–≥–∞–π —Å –ª—é–±—ã–º–∏ —É—á–µ–±–Ω—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏.'},
          ...chatHist.slice(-10)
        ]
      })
    });
    const d = await r.json();
    const reply = d.choices?.[0]?.message?.content || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!';
    chatHist.push({role:'assistant',content:reply});
    document.getElementById('ai-typ')?.remove();
    box.innerHTML += `<div class="msg bot">${reply.replace(/\n/g,'<br>')}</div>`;
    box.scrollTop=box.scrollHeight;
    USER.xp=(USER.xp||0)+3; save(); updateHeader();
  } catch(e) {
    document.getElementById('ai-typ')?.remove();
    box.innerHTML += `<div class="msg bot">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.</div>`;
    box.scrollTop=box.scrollHeight;
  }
}

function quickQ(q) { document.getElementById('chat-inp').value=q; doChat(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MATERIALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function doMat() {
  const q = document.getElementById('mat-q').value.trim();
  if(!q) return;
  const out = document.getElementById('mat-out');
  out.innerHTML = `<div class="mat-card"><div class="mat-ttl">‚è≥ –ò—â—É –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ —Ç–µ–º–µ "${q}"...</div></div>`;
  try {
    const r = await fetch(AI_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${AI_KEY}`},
      body:JSON.stringify({model:AI_MDL, messages:[{
        role:'user',
        content:`–°–æ—Å—Ç–∞–≤—å —É—á–µ–±–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –ø–æ —Ç–µ–º–µ "${q}" –¥–ª—è —à–∫–æ–ª—å–Ω–∏–∫–∞. –î–∞–π 4 –±–ª–æ–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
–ó–ê–ì–û–õ–û–í–û–ö|–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
–†–∞–∑–¥–µ–ª—è–π –±–ª–æ–∫–∏ —Ç—Ä–µ–º—è —Ä–µ—à—ë—Ç–∫–∞–º–∏ ###
–û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç–æ–π –ø–æ–Ω—è—Ç–Ω—ã–π —è–∑—ã–∫.`
      }]})
    });
    const d = await r.json();
    const txt = d.choices?.[0]?.message?.content || '';
    const blocks = txt.split('###').filter(b=>b.trim());
    out.innerHTML = blocks.map(b=>{
      const pts=b.split('|');
      const ttl=pts[0]?.replace(/\*\*/g,'').trim()||'–ú–∞—Ç–µ—Ä–∏–∞–ª';
      const body=pts[1]?.trim()||b.trim();
      return `<div class="mat-card"><div class="mat-ttl">${ttl}</div><div class="mat-body">${body.replace(/\n/g,'<br>')}</div></div>`;
    }).join('') || `<div class="mat-card"><div class="mat-body">${txt.replace(/\n/g,'<br>')}</div></div>`;
    USER.xp=(USER.xp||0)+5; save(); updateHeader();
  } catch(e) {
    out.innerHTML=`<div class="mat-card"><div class="mat-ttl">‚ùå –û—à–∏–±–∫–∞</div><div class="mat-body">–ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.</div></div>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function save() { localStorage.setItem('ssd_user',JSON.stringify(USER)); }

function getSchedule() {
  const all = JSON.parse(localStorage.getItem('ssd_sch')||'{}');
  const key = `${USER.school}::${USER.cls}`;
  return all[key] || defaultSch();
}

function defaultSch() {
  return {
    0:[{name:'–ê–ª–≥–µ–±—Ä–∞',teacher:'',room:'101'},{name:'–†—É—Å—Å–∫–∏–π —è–∑—ã–∫',teacher:'',room:'205'},{name:'–ò—Å—Ç–æ—Ä–∏—è',teacher:'',room:'308'},{name:'–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞',teacher:'',room:'–ó–∞–ª'},{name:'–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫',teacher:'',room:'402'}],
    1:[{name:'–ì–µ–æ–º–µ—Ç—Ä–∏—è',teacher:'',room:'101'},{name:'–§–∏–∑–∏–∫–∞',teacher:'',room:'303'},{name:'–•–∏–º–∏—è',teacher:'',room:'204'},{name:'–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',teacher:'',room:'205'},{name:'–ë–∏–æ–ª–æ–≥–∏—è',teacher:'',room:'206'}],
    2:[{name:'–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞',teacher:'',room:'101'},{name:'–†—É—Å—Å–∫–∏–π —è–∑—ã–∫',teacher:'',room:'205'},{name:'–ì–µ–æ–≥—Ä–∞—Ñ–∏—è',teacher:'',room:'307'},{name:'–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫',teacher:'',room:'402'},{name:'–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞',teacher:'',room:'115'}],
    3:[{name:'–ò—Å—Ç–æ—Ä–∏—è',teacher:'',room:'308'},{name:'–§–∏–∑–∏–∫–∞',teacher:'',room:'303'},{name:'–ê–ª–≥–µ–±—Ä–∞',teacher:'',room:'101'},{name:'–û–ë–ñ',teacher:'',room:'201'},{name:'–•–∏–º–∏—è',teacher:'',room:'204'}],
    4:[{name:'–ë–∏–æ–ª–æ–≥–∏—è',teacher:'',room:'206'},{name:'–ì–µ–æ–º–µ—Ç—Ä–∏—è',teacher:'',room:'101'},{name:'–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞',teacher:'',room:'–ó–∞–ª'},{name:'–ú–•–ö',teacher:'',room:'411'},{name:'–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',teacher:'',room:'205'}],
  };
}

function getHW() { return JSON.parse(localStorage.getItem('ssd_hw')||'[]'); }

function getLB()  { return JSON.parse(localStorage.getItem('ssd_lb')||'[]'); }

function addToLB() {
  if(!USER) return;
  let lb = getLB();
  const idx = lb.findIndex(u=>u.phone===USER.phone);
  const e = {phone:USER.phone,fio:USER.fio,school:USER.school,cls:USER.cls,xp:USER.xp||0};
  if(idx>=0) lb[idx]=e; else lb.push(e);
  // –î–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –µ—Å–ª–∏ –æ–¥–∏–Ω–æ–∫–æ
  if(lb.filter(u=>u.cls===USER.cls).length < 3) {
    const fakes=[
      {phone:'fx1',fio:'–ê–ª–µ–∫—Å–µ–π –ü–µ—Ç—Ä–æ–≤',school:USER.school,cls:USER.cls,xp:185},
      {phone:'fx2',fio:'–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞',school:USER.school,cls:USER.cls,xp:140},
      {phone:'fx3',fio:'–î–º–∏—Ç—Ä–∏–π –ö–æ–∑–ª–æ–≤',school:USER.school,cls:USER.cls,xp:95},
    ];
    fakes.forEach(f=>{if(!lb.find(u=>u.phone===f.phone))lb.push(f);});
  }
  localStorage.setItem('ssd_lb',JSON.stringify(lb));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fillAdmSchools() {
  const sel = document.getElementById('adm-school');
  sel.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —à–∫–æ–ª—É --</option>';
  ALL_SCHOOLS.forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;sel.appendChild(o);});
}

function setupKbd() {
  let seq = [];
  document.addEventListener('keydown', e => {
    seq.push(e.key);
    if(seq.length>8) seq.shift();
    // Ctrl + Escape
    if(seq.includes('Control') && seq.includes('Escape')) {
      seq=[];
      document.getElementById('adm-pw').classList.add('on');
      document.getElementById('adm-pw-in').value='';
      document.getElementById('adm-pw-err').textContent='';
    }
  });
}

function closeAdmPw() { document.getElementById('adm-pw').classList.remove('on'); }

function checkAdmPw() {
  const school = document.getElementById('adm-school').value;
  const pw     = document.getElementById('adm-pw-in').value;
  if(!school) { document.getElementById('adm-pw-err').textContent='–í—ã–±–µ—Ä–∏—Ç–µ —à–∫–æ–ª—É'; return; }
  const correct = SCHOOL_PASSWORDS[school];
  if(!correct || pw !== correct) {
    document.getElementById('adm-pw-err').textContent='–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
    return;
  }
  admSchool = school;
  closeAdmPw();
  openAdm();
}

function openAdm() {
  const panel = document.getElementById('adm');
  panel.classList.add('on');
  document.getElementById('adm-school-name').textContent=admSchool;

  const cls = document.getElementById('adm-cls');
  cls.innerHTML='<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å --</option>';
  CLASSES.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;cls.appendChild(o);});

  const hwCls = document.getElementById('hw-cls');
  hwCls.innerHTML='<option value="">–î–ª—è –∫–ª–∞—Å—Å–∞...</option>';
  CLASSES.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;hwCls.appendChild(o);});

  admDay=0;
  loadAdmSch();
}

function closeAdm() { document.getElementById('adm').classList.remove('on'); }

function setAdmDay(d,el) {
  admDay=d;
  document.querySelectorAll('.adm-day').forEach(x=>x.className='adm-day');
  el.className='adm-day on';
  loadAdmSch();
}

function loadAdmSch() {
  const cls = document.getElementById('adm-cls').value;
  if(!cls) { document.getElementById('adm-lessons').innerHTML='<div style="color:var(--muted);font-size:.85rem">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</div>'; return; }
  const all=JSON.parse(localStorage.getItem('ssd_sch')||'{}');
  const key=`${admSchool}::${cls}`;
  const sch=all[key]||{};
  admLessons=JSON.parse(JSON.stringify(sch[admDay]||[{name:'',teacher:'',room:''}]));
  renderAdmLessons();
}

function renderAdmLessons() {
  document.getElementById('adm-lessons').innerHTML = admLessons.map((l,i)=>`
    <div class="lesson-edit-row">
      <div class="lesson-num-lbl">${i+1}</div>
      <input value="${l.name||''}" placeholder="–ü—Ä–µ–¥–º–µ—Ç" oninput="admLessons[${i}].name=this.value">
      <input value="${l.teacher||''}" placeholder="–£—á–∏—Ç–µ–ª—å" class="sm" oninput="admLessons[${i}].teacher=this.value">
      <input value="${l.room||''}" placeholder="–ö–∞–±." class="xs" oninput="admLessons[${i}].room=this.value">
      <button class="del-btn" onclick="admLessons.splice(${i},1);renderAdmLessons()">‚úï</button>
    </div>`).join('');
}

function addAdmLesson() {
  admLessons.push({name:'',teacher:'',room:''});
  renderAdmLessons();
}

function saveAdm() {
  const cls = document.getElementById('adm-cls').value;
  if(!cls) { showToast('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å!'); return; }

  // Save schedule
  const all=JSON.parse(localStorage.getItem('ssd_sch')||'{}');
  const key=`${admSchool}::${cls}`;
  if(!all[key]) all[key]={};
  all[key][admDay]=admLessons.filter(l=>l.name.trim());
  localStorage.setItem('ssd_sch',JSON.stringify(all));

  // Save HW
  const subj=document.getElementById('hw-subj').value.trim();
  const desc=document.getElementById('hw-desc').value.trim();
  const date=document.getElementById('hw-date').value;
  const diff=document.getElementById('hw-diff').value;
  const hwCls=document.getElementById('hw-cls').value||cls;

  if(subj && desc) {
    const hw=getHW();
    hw.push({id:Date.now()+'',subj,desc,date,diff,cls:hwCls,school:admSchool,day:admDay});
    localStorage.setItem('ssd_hw',JSON.stringify(hw));
    document.getElementById('hw-subj').value='';
    document.getElementById('hw-desc').value='';
    document.getElementById('hw-date').value='';
  }

  showToast('‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –∑–∞–¥–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
  if(USER && USER.school===admSchool && USER.cls===cls) {
    renderSchedule(); renderHW(); renderHome();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg) {
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PASSWORD REFERENCE (–¥–ª—è –∫–æ–Ω—Å–æ–ª–∏)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
console.log('%c –ü–ê–†–û–õ–ò –£–ß–ò–¢–ï–õ–ï–ô ‚Äî SmartDiary', 'font-size:16px;font-weight:bold;color:#3D6FFF');
ALL_SCHOOLS.forEach(s => console.log(`${s}  ‚Üí  ${SCHOOL_PASSWORDS[s]}`));
console.log('\n%c–î–ª—è –≤—Ö–æ–¥–∞ –≤ –ø–∞–Ω–µ–ª—å —É—á–∏—Ç–µ–ª—è: –Ω–∞–∂–º–∏ Ctrl+Esc', 'color:gray');
</script>
</body>
</html>